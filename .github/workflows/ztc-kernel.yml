name: 构建 Marble 内核 (Android 12 5.10)

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      kernelsu_variant:
        description: "选择 KernelSU 变体"
        required: true
        type: choice
        options:
          - Official
          - Next
          - MKSU
          - SukiSU
        default: SukiSU
      kernelsu_branch:
        description: "选择 KSU 分支"
        required: true
        type: choice
        options:
          - Stable(标准)
          - Dev(开发)
        default: Stable(标准)
      version:
        description: '自定义版本名'
        required: false
        type: string
      use_zram:
        description: '是否开启增加更多ZRAM算法?'
        required: true
        type: boolean
        default: true
      use_bbg:
        description: '是否开启BBG防格机补丁?'
        required: true
        type: boolean
        default: true
      use_kpm:
        description: '是否开启KPM功能?'
        required: true
        type: boolean
        default: true
      get_manager:
        description: '获取最新KSU管理器和SUS模块?'
        required: true
        type: boolean
        default: true
      onlyAk3:
        description: '仅上传AK3压缩包?'
        required: false
        type: boolean
        default: false
      build_time:
        description: '设置内核构建时间'
        required: false
        type: string

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: Maximize Build Space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-large-packages: 'true'
          remove-swapfile: 'true'
          verbose: 'true'

      - name: 安装依赖
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y ccache python3 git curl build-essential libssl-dev bison flex libelf-dev dwarves

      - name: 配置 ccache
        run: |
          mkdir -p ~/.cache/bazel
          ccache --version
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      - name: 从缓存中还原ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: marble-kernel-ccache-${{ github.sha }}
          restore-keys: |
            marble-kernel-ccache-

      - name: 下载工具链
        run: |
          AOSP_MIRROR=https://android.googlesource.com
          BRANCH=main-kernel-build-2024
          git clone $AOSP_MIRROR/kernel/prebuilts/build-tools -b $BRANCH --depth 1 kernel-build-tools
          git clone $AOSP_MIRROR/platform/system/tools/mkbootimg -b $BRANCH --depth 1 mkbootimg

      - name: 设置环境变量
        run: |
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py" >> $GITHUB_ENV
          echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py" >> $GITHUB_ENV

      - name: 配置 Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: 克隆 Marble 内核源码
        run: |
          echo "克隆 Marble 内核源码..."
          git clone https://github.com/Guxin12/android_kernel_xiaomi_marble.git kernel-source
          cd kernel-source
          echo "内核源码已克隆到: $(pwd)"

      - name: 克隆依赖仓库
        run: |
          echo "克隆依赖仓库..."
          git clone https://github.com/WildPlusKernel/AnyKernel3.git -b "gki-2.0"
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "gki-android12-5.10"
          git clone https://github.com/WildPlusKernel/kernel_patches.git
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          git clone https://github.com/zzh20188/GKI_KernelSU_SUSFS.git zzh_patch

      - name: 确定 KernelSU 分支
        run: |
          branch_input="${{ inputs.kernelsu_branch }}"
          variant_input="${{ inputs.kernelsu_variant }}"

          case "$branch_input" in
            "Stable(标准)")
              case "$variant_input" in
                "Next")
                  echo "BRANCH=-s next" >> $GITHUB_ENV
                  ;;
                "SukiSU")
                  echo "BRANCH=-s susfs-main" >> $GITHUB_ENV
                  ;;
                *)
                  echo "BRANCH=-" >> $GITHUB_ENV
                  ;;
              esac
              ;;
            "Dev(开发)")
              case "$variant_input" in
                "Official" | "MKSU") echo "BRANCH=-s main" >> $GITHUB_ENV ;;
                "Next")              echo "BRANCH=-s next" >> $GITHUB_ENV ;;
                "SukiSU")           echo "BRANCH=-s susfs-test" >> $GITHUB_ENV ;;
                *) 
                  echo "错误：未定义开发分支的变体 '$variant_input'" >&2
                  exit 1
                  ;;
              esac
              ;;
          esac

      - name: 添加 KernelSU
        run: |
          cd kernel-source
          echo "添加 KernelSU..."

          if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "Adding KernelSU Official..."
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "Adding KernelSU Next..."
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            echo "Adding KernelSU MKSU..."
            curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "Adding KernelSU SukiSU..."
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash $BRANCH
          fi

      - name: 为 KernelSU 变体安装 SUSFS 补丁
        run: |
          cd kernel-source
          echo "应用 SUSFS 补丁..."

          # 复制 SUSFS 补丁
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch ./
          cp -r ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp -r ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/

          if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "Applying SUSFS patches for Official KernelSU..."
            cd ./KernelSU
            cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 --forward < 10_enable_susfs_for_ksu.patch || true
          elif [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "Applying SUSFS patches for KernelSU-Next..."
            cd ./KernelSU-Next
            if [ "$BRANCH" == "-s next" ]; then
              echo "当前为Dev分支的KernelSU-Next"
              cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
              patch -p1 < 10_enable_susfs_for_ksu.patch || true
              echo "应用临时修复补丁"
              cp ../../zzh_patch/next-patch/* ./
              patch -p1 < fix_apk_sign.c.patch || true
              patch -p1 < fix_core_hook.c.patch || true
              patch -p1 < fix_sucompat.c.patch || true
              patch -p1 < fix_kernel_compat.c.patch || true
            fi
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            echo "Applying SUSFS patches for MKSU..."
            cd ./KernelSU
            cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 --forward < 10_enable_susfs_for_ksu.patch || true
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "Applying SUSFS patches for SukiSU..."
            cd ./KernelSU
            echo "Applying SukiSU specific SUSFS patch..."
          fi

          cd ..
          patch -p1 --fuzz=3 < 50_add_susfs_in_gki-android12-5.10.patch || true

      - name: 应用新的HOOKS补丁
        run: |
          cd kernel-source
          if [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "Applying hooks for KernelSU-Next..."
            cp ../kernel_patches/next/scope_min_manual_hooks_v1.4.patch ./
            patch -p1 -F 3 < scope_min_manual_hooks_v1.4.patch || true
          fi

      - name: 升级LZ4至1.10.0
        if: ${{ inputs.use_zram }}
        run: |
          cd kernel-source
          echo '升级 LZ4'
          
          # 删除lz4库旧有文件
          files=(
              "lib/lz4/lz4_compress.c"
              "lib/lz4/lz4_decompress.c"
              "lib/lz4/lz4defs.h"
              "lib/lz4/lz4hc_compress.c"
          )

          for file in "${files[@]}"; do
              if [ -e "$file" ]; then
                  rm "$file"
                  echo "$file 已删除"
              else
                  echo "$file 不存在"
              fi
          done

          cp -r ../zzh_patch/zram/lz4/* ./lib/lz4/
          cp -r ../zzh_patch/zram/include/linux/* ./include/linux/
          cp ../zzh_patch/zram/5.10/lz4_1.10.0.patch ./

          patch -p1 -F 3 --fuzz=5 < lz4_1.10.0.patch || true

      - name: 复制源文件 & 应用LZ4KD补丁
        if: ${{ inputs.use_zram }}
        run: |
          cd kernel-source
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./lib/
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto/
          cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./lib/

          cp ../SukiSU_patch/other/zram/zram_patch/5.10/lz4kd.patch ./
          echo "正在打lz4kd补丁"
          patch -p1 -F 3 < lz4kd.patch || true

      - name: 配置内核
        run: |
          cd kernel-source
          
          # 添加 KSU 配置
          echo "CONFIG_KSU=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          
          # 添加 SUSFS 配置
          echo "CONFIG_KSU_SUSFS=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> ./arch/arm64/configs/vendor/marble_defconfig

          if [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "CONFIG_KSU_KPROBES_HOOK=n" >> ./arch/arm64/configs/vendor/marble_defconfig
            echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> ./arch/arm64/configs/vendor/marble_defconfig
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "CONFIG_KPM=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          fi

          if ${{ inputs.use_zram }}; then
            echo "CONFIG_ZRAM=y" >> ./arch/arm64/configs/vendor/marble_defconfig
            echo "CONFIG_ZRAM_DEF_COMP_LZ4KD=y" >> ./arch/arm64/configs/vendor/marble_defconfig
            echo "CONFIG_CRYPTO_LZ4HC=y" >> ./arch/arm64/configs/vendor/marble_defconfig
            echo "CONFIG_CRYPTO_LZ4K=y" >> ./arch/arm64/configs/vendor/marble_defconfig
            echo "CONFIG_CRYPTO_LZ4KD=y" >> ./arch/arm64/configs/vendor/marble_defconfig
            echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> ./arch/arm64/configs/vendor/marble_defconfig
          fi

      - name: BBG patch
        if: ${{ inputs.use_bbg }}
        run: |
          cd kernel-source
          echo "Adding BBG..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          echo "CONFIG_BBG=y" >> arch/arm64/configs/vendor/marble_defconfig

      - name: 配置内核构建时间
        run: |
          cd kernel-source
          CURRENT_TIME=""

          if [ ! -z "${{ inputs.build_time }}" ]; then
            echo "使用自定义构建时间"
            CURRENT_TIME="${{ inputs.build_time }}"
          else
            echo "使用当前时间"
            CURRENT_TIME=$(date -u +"%a %b %d %H:%M:%S UTC %Y")
          fi
          
          echo "构建时间: $CURRENT_TIME"
          perl -pi -e "s{UTS_VERSION=\"\\\$\(echo \\\$UTS_VERSION \\\$CONFIG_FLAGS \\\$TIMESTAMP \\| cut -b -\\\$UTS_LEN\)\"}{UTS_VERSION=\"#1 SMP PREEMPT $CURRENT_TIME\"}" ./scripts/mkcompile_h

      - name: 配置内核版本
        run: |
          cd kernel-source
          if [ ! -z "${{ inputs.version }}" ]; then
            echo "使用自定义版本: ${{ inputs.version }}"
            sed -i '$s|echo "\$res"|echo "${{ inputs.version }}"|' ./scripts/setlocalversion
          fi

      - name: 编译内核
        run: |
          cd kernel-source
          echo "开始编译内核..."
          
          # 设置环境变量
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # 使用 defconfig
          make vendor/marble_defconfig
          
          # 编译内核
          make -j$(nproc) CC="/usr/bin/ccache clang"

      - name: 创建 AnyKernel3 包
        run: |
          echo "创建 AnyKernel3 包..."
          cd AnyKernel3
          cp ../kernel-source/arch/arm64/boot/Image ./Image
          ZIP_NAME="marble-kernel-${{ inputs.kernelsu_variant }}-${{ github.run_number }}.zip"
          zip -r "../$ZIP_NAME" ./*

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: marble-kernel-${{ inputs.kernelsu_variant }}
          path: |
            *.zip
            kernel-source/arch/arm64/boot/Image

  get-manager:
    if: ${{ inputs.get_manager }}
    runs-on: ubuntu-latest
    steps:
      - name: 获取 KSU 管理器
        run: |
          if [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "KernelSU Next..."
            REPO="KernelSU-Next/KernelSU-Next"
            KSUM="Manager"
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "SukiSU..."
            REPO="SukiSU-Ultra/SukiSU-Ultra"
            KSUM="Manager"
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            echo "MKSU..."
            REPO="5ec1cff/KernelSU"
            KSUM="manager"
          elif [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "KSU..."
            REPO="tiann/KernelSU"
            KSUM="manager"
          fi

          FILENAME=$([[ "${{ inputs.kernelsu_variant }}" == "Next" ]] && echo "build-manager-ci.yml" || echo "build-manager.yml")
          
          # 获取最新的构建
          BUILD_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/actions/workflows/$FILENAME/runs?status=success" |
            jq -r '.workflow_runs[0].id')

          ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/actions/runs/$BUILD_ID/artifacts")

          DOWNLOAD_URL=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name | contains("'"$KSUM"'")) | .archive_download_url')

          # 下载 Manager 文件
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "manager.zip" "$DOWNLOAD_URL"
          unzip manager.zip
          rm -rf manager.zip

      - name: 上传管理器
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.kernelsu_variant }}-Manager
          path: |
            *.apk
