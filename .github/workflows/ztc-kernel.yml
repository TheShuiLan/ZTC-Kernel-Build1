name: ZTC Kernel Build
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      kernelsu_variant:
        description: "选择 KernelSU"
        required: true
        type: choice
        options:
          - Official
          - Next
          - MKSU
          - SukiSU
        default: SukiSU
      kernelsu_branch:
        description: "选择 ksu 分支"
        required: true
        type: choice
        options:
          - Stable(标准)
          - Dev(开发)
          - Other(其他/指定)
        default: Stable(标准)
      version:
        description: '自定义版本名(如5.10.198后面的字符/留空则使用默认版本号)'
        required: false
        type: string
      build_time:
        description: '设置内核构建时间(格式见仓库说明)'
        required: false
        type: string
      use_zram:
        description: '是否开启增加更多ZRAM算法?'
        required: true
        type: boolean
        default: true
      use_bbg:
        description: '是否开启BBG防格机补丁?（报错请关闭）'
        required: true
        type: boolean
        default: true
      use_kpm:
        description: '是否开启KPM功能?'
        required: true
        type: boolean
        default: true
      get_manager:
        description: '获取最新KSU管理器和SUS模块?'
        required: true
        type: boolean
        default: true
      onlyAk3:
        description: '仅上传AK3压缩包?(无boot,下载更快)'
        required: false
        type: boolean
        default: false

jobs:
  build-kernel-kernelsu-susfs:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: Maximize Build Space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-large-packages: 'true'
          remove-swapfile: 'true'
          remove-cached-tools: 'false'
          verbose: 'true'

      - name: 设定 CONFIG 环境变量
        run: |
          CONFIG="android12-5.10-lts"
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV
          echo "CONFIG set to: $CONFIG"

      - name: 安装 依赖
        run: sudo apt update && sudo apt upgrade -y && sudo apt install -y ccache python3 git curl build-essential libssl-dev bison flex libelf-dev dwarves

      - name: 配置 ccache
        run: |
          mkdir -p ~/.cache/bazel
          ccache --version
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      - name: 配置 Git
        run: |
          git config --global user.name "zzh20188"
          git config --global user.email "BuildGkiKernel@gmail.com"
      
      - name: 安装仓库
        run: |
          mkdir -p ./git-repo
          curl https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/./git-repo/repo" >> $GITHUB_ENV

      - name: 克隆 AnyKernel3
        run: |
          echo "Cloning AnyKernel3..."
          ANYKERNEL_BRANCH="gki-2.0"
          git clone https://github.com/WildPlusKernel/AnyKernel3.git -b "$ANYKERNEL_BRANCH"

      - name: 下载并设置工具链
        run: |
          echo "Downloading and setting up toolchain..."
          mkdir -p toolchain
          cd toolchain
          
          # 尝试多个可能的工具链源
          echo "尝试下载 Clang 工具链..."
          
          # 方法1: 从 Google 官方源下载
          if curl -LSs "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r563880.tar.gz" -o clang.tar.gz && \
             tar -xzf clang.tar.gz; then
            echo "成功从 Google 官方源下载工具链"
          # 方法2: 从 GitHub 备用源下载
          elif curl -LSs "https://github.com/llvm/llvm-project/releases/download/llvmorg-16.0.0/clang+llvm-16.0.0-x86_64-linux-gnu-ubuntu-18.04.tar.xz" -o clang.tar.xz && \
               tar -xf clang.tar.xz; then
            echo "成功从 LLVM 官方源下载工具链"
            mv clang+llvm-16.0.0-x86_64-linux-gnu-ubuntu-18.04 clang-r563880
          # 方法3: 使用系统自带的 clang
          else
            echo "使用系统自带的 clang"
            mkdir -p clang-r563880/bin
            ln -sf $(which clang) clang-r563880/bin/clang
            ln -sf $(which clang++) clang-r563880/bin/clang++
          fi
          
          # 设置工具链路径
          export CLANG_PATH="$GITHUB_WORKSPACE/toolchain/clang-r563880/bin"
          echo "CLANG_PATH=$CLANG_PATH" >> $GITHUB_ENV
          echo "PATH=$CLANG_PATH:$PATH" >> $GITHUB_ENV

      - name: 克隆内核源代码
        run: |
          echo "Creating folder for configuration: $CONFIG..."
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          
          echo "Cloning kernel source from GitHub..."
          git clone https://github.com/Pzqqt/android_kernel_xiaomi_marble.git --depth=1 common
          
          cd common
          # 更新构建配置使用我们下载的 clang
          if [ -f "build.config.common" ]; then
            sed -i "s|^CLANG_PREBUILT_BIN=.*|CLANG_PREBUILT_BIN=$CLANG_PATH|" build.config.common
          fi

      - name: 验证工具链
        run: |
          echo "验证工具链..."
          echo "CLANG_PATH: $CLANG_PATH"
          ls -la $CLANG_PATH || echo "Clang 目录不存在"
          which clang
          clang --version || echo "Clang 不可用"

      - name: 获取 KSU & SUSFS 版本
        run: |
          echo "获取 KSU 版本信息..."
          git clone https://github.com/tiann/KernelSU.git KernelSU
          VAR=200
          cd KernelSU

          KSU_GIT_VERSION=$(git rev-list --count HEAD)
          KSU_VERSION=$((10000 + KSU_GIT_VERSION + VAR))
          echo $KSU_VERSION
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV

          INFO="https://gitlab.com/simonpunk/susfs4ksu/-/raw/gki-android14-6.1/ksu_module_susfs/module.prop\?ref_type\=heads"
          SUS_VERSION=$(curl -s $INFO | awk -F '=' '$1 == "version" { print $2 }')
          echo $SUS_VERSION

          echo "kversion=$KSU_VERSION" >> $GITHUB_OUTPUT
          echo "sversion=$SUS_VERSION" >> $GITHUB_OUTPUT

      - name: 查看SUSFS配置设置
        run: |
          echo "查看内核配置..."
          cd "$CONFIG"
          if [ -f "./common/build.config.gki" ]; then
            sed -i 's/check_defconfig//' ./common/build.config.gki
          fi

          if [ -f "./common/arch/arm64/configs/gki_defconfig" ]; then
            tail -n 60 ./common/arch/arm64/configs/gki_defconfig
          fi

      - name: 配置内核构建时间/删除dirty字符
        run: |
          echo "配置内核版本..."
          cd "$CONFIG"

          echo "删除dirty字符串"
          if [ -f "./common/scripts/setlocalversion" ]; then
            sed -i 's/-dirty//' ./common/scripts/setlocalversion
          fi
          
      - name: 确定 KernelSU 的分支
        run: |
          branch_input="${{ inputs.kernelsu_branch }}"
          variant_input="${{ inputs.kernelsu_variant }}"

          case "$branch_input" in
            "Stable(标准)")
              case "$variant_input" in
                "Next")
                  echo "BRANCH=-s next" >> $GITHUB_ENV
                  ;;
                "SukiSU")
                  echo "BRANCH=-s susfs-main" >> $GITHUB_ENV
                  ;;
                *)
                  echo "BRANCH=-" >> $GITHUB_ENV
                  ;;
              esac
              ;;
            "Dev(开发)")
              case "$variant_input" in
                "Official" | "MKSU") echo "BRANCH=-s main" >> $GITHUB_ENV ;;
                "Next")              echo "BRANCH=-s next" >> $GITHUB_ENV ;;
                "SukiSU")           echo "BRANCH=-s susfs-test" >> $GITHUB_ENV ;;
                *) 
                  echo "错误：未定义开发分支的变体 '$variant_input'" >&2
                  exit 1
                  ;;
              esac
              ;;
            *)
              echo "错误：需要自定义分支时未提供参数" >&2
              exit 1
              ;;
          esac

      - name: 添加 KernelSU
        run: |
          echo "添加 KernelSU..."
          cd "$CONFIG"

          if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "Adding KernelSU Official..."
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "Adding KernelSU Next..."
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            echo "Adding KernelSU MKSU..."
            curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "Adding KernelSU SukiSU..."
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash $BRANCH
          fi
          
      - name: Build with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 90
          max_attempts: 3
          retry_on: timeout
          command: |
            set -e
            set -x
            cd "$CONFIG/common"
            
            echo "Building the kernel..."
            
            # 配置内核
            echo "Configuring kernel..."
            make O=out ARCH=arm64 CC="clang" gki_defconfig || \
            make O=out ARCH=arm64 CC="clang" vendor/gki_defconfig || \
            make O=out ARCH=arm64 CC="clang" defconfig
            
            # 如果上面失败，尝试直接复制配置文件
            if [ ! -f "out/.config" ]; then
              echo "Using fallback config method..."
              if [ -f "arch/arm64/configs/gki_defconfig" ]; then
                cp arch/arm64/configs/gki_defconfig out/.config
              elif [ -f "arch/arm64/configs/vendor/gki_defconfig" ]; then
                cp arch/arm64/configs/vendor/gki_defconfig out/.config
              fi
            fi
            
            # 构建内核
            echo "Starting kernel build..."
            make O=out ARCH=arm64 CC="clang" -j$(nproc) || exit 1

      - name: 创建Bootimgs文件夹并复制镜像
        run: |
          echo "复制内核镜像..."
          mkdir -p bootimgs

          if [ -f "./$CONFIG/common/out/arch/arm64/boot/Image" ]; then
            cp ./$CONFIG/common/out/arch/arm64/boot/Image ./bootimgs
            cp ./$CONFIG/common/out/arch/arm64/boot/Image ./
          elif [ -f "./$CONFIG/common/arch/arm64/boot/Image" ]; then
            cp ./$CONFIG/common/arch/arm64/boot/Image ./bootimgs
            cp ./$CONFIG/common/arch/arm64/boot/Image ./
          fi

          if [ -f "./Image" ]; then
            gzip -n -k -f -9 ./Image > ./Image.gz
          fi

      - name: 创建AnyKernel3 ZIP文件
        run: |
          echo "创建 AnyKernel3 ZIP 文件..."
          cd ./AnyKernel3

          ZIP_NAME="ZTC-AnyKernel3.zip"
          echo "Creating zip file: $ZIP_NAME..."
          if [ -f "../Image" ]; then
            mv ../Image ./Image
            zip -r "../$ZIP_NAME" ./*
          fi

      - name: 添加 KernelSU Manager
        if: ${{ inputs.get_manager }}
        id: add_KSU
        continue-on-error: true
        run: |
          REPO="tiann/KernelSU"
          FILENAME="build-manager.yml"
          KSUM="manager"
          
          NUMBER=0
          DOWNLOAD_URL=""

          echo "开始查找 KernelSU Manager..."
          while true; do
            echo "--------------------------------------------------"
            echo "正在检查第 ${NUMBER} 个历史构建..."

            if [ "$NUMBER" -ge 9 ]; then
              echo "查找九次仍然失败，跳出循环。"
              break
            fi

            BUILD_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/actions/workflows/$FILENAME/runs?status=success" |
              jq -r '.workflow_runs['"$NUMBER"'].id')

            echo "找到构建 ID: $BUILD_ID"

            ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/actions/runs/$BUILD_ID/artifacts")

            result=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name | contains("'"$KSUM"'")) | .name')

            if [ -z "$result" ]; then
              echo "没有找到包含 '$KSUM' 的项"
              NUMBER=$((NUMBER + 1))
            else
              echo "$result"
              DOWNLOAD_URL=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name == "'"$KSUM"'") | .archive_download_url')
              break
            fi
          done
          
          if [ -n "$DOWNLOAD_URL" ]; then
            curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "KSU-管理器(${{ env.KSU_VERSION }}).zip" "$DOWNLOAD_URL"
            echo "Manager 文件已下载为：KSU-管理器(${{ env.KSU_VERSION }}).zip"
            unzip -q *.zip || true
            rm -rf *.zip
          fi
  
      - name: 添加 SUSFS 模块
        if: ${{ inputs.get_manager }}
        id: add_SUSFS
        continue-on-error: true
        run: |
          BUILD_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/workflows/build.yml/runs?status=success" |
          jq -r '.workflow_runs[0].id')

          ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs/$BUILD_ID/artifacts")

          DOWNLOAD_URL=$(echo "$ARTIFACTS" | jq -r '.artifacts[0].archive_download_url') 

          NAME=$(echo "$ARTIFACTS" | jq -r '.artifacts[0].name')
          echo "SUSFS_NAME=$NAME" >> $GITHUB_ENV
          NAME="susfs-$NAME.zip"
          
          echo $DOWNLOAD_URL
          echo $NAME
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "$NAME" "$DOWNLOAD_URL"
          echo "$NAME 文件已下载.zip"         
          
          echo "正在检查调用者: ${{ github.caller_workflow }}"

          if [ "${{ github.workflow }}" == "测试发布" ]; then
            echo "这是测试发布工作流"
            mkdir -p susfs-module && mv $NAME susfs-module
          else
            echo "这是其他工作流"
            mkdir -p susfs-module && unzip -q *.zip -d susfs-module || true
          fi
      
      - name: 上传编译资产
        uses: actions/upload-artifact@v4
        with:
          name: ZTC-Anykernel3
          path: ./AnyKernel3/*

      - name: 上传APK
        if: ${{ inputs.get_manager }}
        uses: actions/upload-artifact@v4
        with:
          name: KSU-Manager(${{ env.KSU_VERSION }})
          path: |
            *.apk
  
      - name: 上传SUSFS模块
        if: ${{ inputs.get_manager }}
        uses: actions/upload-artifact@v4
        with:
          name: susfs-${{ env.SUSFS_NAME }}
          path: ./susfs-module/*
